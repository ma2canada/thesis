\chapter{Ch3-AsymmetricLogistic}

\section{Invasion Analysis}

In the previous sections the two species obeyed symmetric dynamics, with random fluctuations leading to the eventual extinction of one or the other with equal likelihood. 
The mean time calculated was for this fixation, of either species. 
But if the symmetry is broken, for instance by starting away from the deterministic fixed point, one should not expect an equal likelihood of fixation and extinction for each species. 
%A more detailed analysis should also include the time to fixation \emph{given that a certain species fixates}, called the conditional fixation time. 
%We and others \cite{Chotibut2015} find that starting \emph{near} the deterministic coexistence point is like starting \emph{at} this fixed point, as the system quickly gets drawn to the coexistence point. 
%Starting close to the fixed point adds a deterministic relaxation time that is negligible compared to the mean times calculated in previous sections \cite{Chotibut2015}. 
%However, starting far from the fixed point, and in particular s
Starting close to an axis leads to different timescales than those found above. %\emph{ie.} with one of the populations small,
%This is inspired by two different scenarios. 
For instance, in a scenario where a species is already settled in a niche, a small immigrant population enters or a small mutant strain arises, one that has some niche overlap with the established species. 
One might ask whether this invader will successfully establish itself, and if so, how long would a successful invasion take on average. 
Also of interest is the mean time of a failed invasion attempt. 
Both times set the scale against which one measures the immigration or mutation rate, to conclude whether a system should be a monoculture or show diversity. 
%Alternatively, a clonal wildtype population experiences a mutation event, and the mutant allele either establishes itself in the system or goes extinct. 
%Hence we investigate the scenario where an immigrant joins an established native species, or alternately a mutant arises in an otherwise clonal wildtype population \cite{some}. 
%Using the same equations as before, we remind the reader that neither species has an explicit fitness advantage. 
%We continue to give neither species an explicit fitness advantage. 
In any case we treat the situation where neither the established population nor the invader has an explicit fitness advantage. 
Each species has the same birth and death rates, equations \ref{deathrate} above with symmetric parameters. 
%: the functional forms of their birth and death rates are the same, and only the initial population sizes differ. 
%For a system starting close to one axis in state space, much of the time it will quickly go to that axis and the system will have fixated. 
%But even the slight possibility of going to the coexistence point and hence taking an exponentially long time will dominate the mean time to fixation. 
%The fixation time, even of a system starting close to one axis, will be dominated by any trajectories that
%However, it is no longer useful to consider the mean time to fixation. 
%Any mean fixation times will be dominated by the exponential behaviour observed for all niche overlaps except $a=1$, since half of those trajectories that reach the coexistence point will still contribute to the conditional fixation time of that species. 
%Instead we will consider the mean time to fixation, conditioned on the invader going extinct, and the mean time to a successful invasion. 
However, the system starts with $K-1$ individuals of the established species and $1$ invader. 
%This asymmetry leads to differing behaviour between the species, and so we must condition our calculations on which outcome occurs. 
%Rather than calculate the time to fixation regardless of species, w
The invader strain is successful if it grows to be half of the total population before dying out. 
This success happens with probability $E_s$ and in mean time $\tau_s$. 
We also calculate the mean time conditioned on a failed invasion attempt, $\tau_f$, for which the invading population never establishes itself. 
%We shall calculate the mean time conditioned on the new species either invading the established population or going extinct. 
%A successful invasion is defined here as one lone mutant growing to be half of the total population. 
%To proceed, we define $E_s$ and $\tau_s$ respectively as the probability and mean time conditioned on a successful invasion.  $\tau_f$ is the mean time to extinction if that should happen before the invader is successful. %e invader should first go extinct. 
%We define $E_s(1)$ as the probability of one mutant successfully reaching this proportion. 
%$\tau_s(1)$ is the mean time to invasion, given that the mutant is successfully invading. 
%$\tau_f(1)$ is the mean time to extinction of the mutant, conditioned on the invasion failing and the native species fixating. /[I have no references; these are my definitions that I have made up]

%%%%%%%!!! need to talk about the math, and how it is different from what was done above - is that which is below sufficient???

%\subsection{Expected Limits}%!!!
%expected limits (small $a$ large $a$ for prob and time; ordering at large and small Q)
As before, we expect $a=1$, the complete niche overlap limit, to behave like the WFM model, and $a=0$, the independent limit, to correspond to two single logistic systems. 
%In the WFM model the success probability is proportional to the fraction of individuals of a type; thus for one initial mutant going to either zero or $K/2$ population we expect
For $a=1$ the Kramers-Moyal of the WFM result is \cite{Moran1962}
\begin{equation}
E_{s} = 2/K,
\end{equation}
%The conditional time obeys the difference relation $(\tau_s E_{s})(n+1) - 2(\tau_{s}E_{s})(n) + (\tau_{s}E_{s})(n-1) = -\frac{2 K \Delta t}{K-n}$, where $(\tau_{s}E_{s})(n)$ refers to a product of the probability and mean conditioned time assuming $n$ invaders. 
%At large $K$ one can approximate the left-hand side as a second derivative (this is the Fokker-Planck approach) and solve to get
\begin{equation}
\tau_{s} = \Delta t K^2(K-1)\ln\left(\frac{K}{K-1}\right), 
\end{equation}
%By a similar process one gets
\begin{equation}
\tau_{f} = \Delta t (K-2)\left( \ln\left(K\right) - (K-1)\ln\left(\frac{K}{K-1}\right)\right). 
\end{equation}
For $a=0$ the invading mutant follows the dynamics of a single logistic system with carrying capacity $K$. %!!!under the assumption that the other species is at population $K$, which is only somewhat justified
%for a one dimensional system there is a standard procedure to calculate $E_s$, $\tau_{s}$, and $\tau_{f}$ (see Supporting Information) \cite{Nisbet1982}. 
Calculating $E_s$, $\tau_{s}$, and $\tau_{f}$ for a one dimensional system is a textbook procedure \cite{Nisbet1982} but does not have a compact solution and is shown in the Supporting Information. %and will not be reproduced here (but see the Supporting Information for the calculation). 
%We assume the dominant species is at population $K$, its quasi-steady state value. 
%Then the mutant's invasion probability will obey normal one-dimensional stochastics (see Supporting Information): %the equation
%\begin{equation}%TODO this? or 1-this?
% E_s= \frac{\sum_{i=1}^{K}\prod_{j=1}^i \frac{d(j)}{b(j)}}{1+\sum_{i=1}^{K}\prod_{j=1}^i \frac{d(j)}{b(j)}},
%\end{equation}
%\begin{equation}%TODO this cannot be correct - the indices alone overlap
% \tau_{s} = \frac{1}{E_{s}}\frac{\sum_{j=1}^{K-1}\sum_{i=1}^j E_s(i) \frac{1}{d(i)}\prod_{j=1}^{i-1} \frac{b(j)}{d(j)}}{1+\sum_{j=1}^{K-1} \prod_{h=1}^j \frac{d(h)}{b(h)}},
%\end{equation}
%\begin{equation}
% \tau_{f} = \frac{1}{1-E_{s}}\frac{\sum_{j=1}^{K-1}\sum_{i=1}^j \left( 1-E_s(i)\right) \frac{1}{d(i)}\prod_{j=1}^{i-1} \frac{b(j)}{d(j)}}{1+\sum_{j=1}^{K-1} \prod_{h=1}^j \frac{d(h)}{b(h)}}.
%\end{equation}
%Since this is analogous to the deterministic approach of a fixed point at the carrying capacity, we expect the time to grow logarithmically with the system size. 
%These sums can be evaluated numerically. % and are used in figures \ref{Esucc} - \ref{Tsucc}. 
%We expect the time to grow logarithmically with the system size, similar to the deterministic logistic system approaching the fixed point. 
A one-dimensional deterministic logistic system approaching its fixed point from $n=1$ displays an invasion time that grows logarithmically with the system size (see Supplementary Information), and should also be a good match for $\tau_{s}$. 

\begin{figure}[h]
	\centering
	\begin{minipage}{0.49\linewidth}
		\centering
		\includegraphics[width=1.0\linewidth]{fiftyfifty-probvK.png}
	\end{minipage}
	\begin{minipage}{0.49\linewidth}
		\centering
		\includegraphics[width=1.0\linewidth]{fiftyfifty-probva.png}
	\end{minipage}
	%  \includegraphics[width=0.9\linewidth]{invasion-prob-succ}
	\caption{\emph{Probability of a successful invasion.}
		\emph{Left:} Solid lines are the numerical results, from $a=0$ above to $a=1$ below. The black dotted line is the expected single logistic limit, and the blue dashed line is WFM result. 
		\emph{Right:} The solid blue line shows the results for small carrying capacity ($K=4$), and matches well with the black dotted line $\frac{b_{mut}}{b_{mut}+d_{mut}}$ (see text for details). Successive lines are at larger system size, and approach the dashed blue line of $1-(d_{mut}/b_{mut})$. 
	} \label{Esucc}
\end{figure}

%COMM describe the general features - greater a is lesser probablity; for ts increasing K is increasing t, but not for fail
The calculated invasion probabilities and times are unintuitive, but regarding the asymptotic limits of small and large carrying capacity $K$ allows for an understanding of the results. %COMM figures... are unintuiotiove,  buyt in the limits this is what's happening...
%, as shown in figures \ref{Esucc}, \ref{Tsucc}, and \ref{Tfail},
At small $K$ commonly only a few birth or death events occur before invasion or extinction, and the slowest step determines the timescale. 
%is determined by the slowest rate, the death rate $d_{mut}=\frac{1+a(K-1)}{K}$. 
With $n_{mut}=1$ and $n_{established}=K-1$ this limiting step is the mutant death: with $K=3$ the rates are $d_{mut}=(1+2a)/3\langle1$, $b_{mut}=1$, $d_{est.}=(4+2a)/3=1+d_{mut}\rangle1$, $b_{est.}=2$. 
Hence we expect $\tau \approx \frac{1}{d_{mut}}=\frac{K}{1+a(K-1)}$, 
%$d_m=(1+2a)/3\langle1 vs d_wt=(4+2a)/3=1+d_m vs b_m=1 vs b_wt=2$
%results will be more sensitive to the set-up of the problem, and starting the native species at $K$ or $K-1$ could in principle make a difference. 
%Trivially, for $K=2$ if a mutant is generated then there will be $1$ mutant and $K-1=1$ wildtype organism, and the equal proportion condition is already met. 
%But for $K\geq3$ invasion is not assured, though either way the situation will resolve itself in only a few steps. 
%A failed invasion occurs immediately if the single mutant dies out, which happens at a rate $d_{mutant}=\frac{1+a(K-1)}{K}$ (contrast this with its birth rate of unity, or the death rate of the other species, $\frac{K-1+a}{K}(K-1)$). 
%It is clear that the likelihood of the mutant dying out increases with niche overlap, thus we expect lesser niche overlap to result in a greater probability of successful invasion. 
%The death rate goes from order $1/K$ to order $1$ as the niche overlap parameter increases. 
%Thus w
with smaller niche overlap resulting in greater mean times, both of invasion and extinction. %probability of successful invasion. 
The invasion probability at this low $K$ is the probability that the mutant reproduces before it dies, namely $\frac{b_{mut}}{b_{mut}+d_{mut}} = \frac{K}{K(1+a)+1-a}$. 
%Similarly, because the rates are greater with greater $a$ we expect the conditioned times to anticorrelate with niche overlap. 
%
In the other extreme, at large $K$, invasion will be likely and fast, as the stochastic drift draws the system to the deterministic fixed point for incomplete niche overlap. 
%Invasions will be likely and fast. 
%This is because at a low number of mutants the per capita birth rate is approximately $1$ and per capita death rate $a$ as $K\rightarrow\infty$. 
The invader birth and death rates can be approximated as constant for small invader number and large carrying capacity: a system with constant rates has an extinction probability of $d_{mut}/b_{mut}$ \cite{Allen2005,Allen2003}, which in this case implies $E_{s} \approx 1-a$. 
%Only in the WFM limit of $a=1$ will the invasion probability go asymptotically to zero at large carrying capacity. 
The invasion probability go asymptotically to zero at large carrying capacity only in the WFM limit of $a=1$. 

%\subsection{Observations}
%stuff as expected
Figures \ref{Esucc}, \ref{Tsucc}, and \ref{Tfail} confirm our predictions for small and large $K$, respectively showing the invasion probability, mean time conditioned on invasion, and mean time conditioned on extinction of the invader. 
%The results generally match the predictions of the previous paragraphs. 
Note that at small carrying capacity the WFM limit has the shortest conditional times, but at large carrying capacity this complete niche overlap has the longest. 
%The suggested ordering of expected times with niche overlap at small and large carrying capacity is observed. 
%The WFM limit in red and the independent limit in black both match well with the data. 
%It is noteworthy that a
%A greater niche overlap leads to faster fixation at small system size but slower times at large $K$. 
In general, increasing $a$ has conflicting effects; it brings the fixed point closer to the initial condition of one invader, suggesting a shorter timescale, but it also makes the two species more similar, effectively reducing the fast approach to the attractive deterministic fixed point. 
This non-monotonic dependence on $a$ causes the unimodality of the conditional times in figures \ref{Tsucc} and \ref{Tfail}. 
% characterized by more back-and-forth dynamics and a longer timescale. 
%TODO The low $K$ pattern of $E_{s} \approx 1-d_{mut}/(b_{mut}+d_{mut})$ is plotted in figure \ref{Esucc} and shows some agreement, though it is not entirely correct. %TODO this does not follow; Anton's comment
%Figure \ref{Esucc} shows that at low $K$ the probabilities, while not quite converging, have a much lesser range than their high $K$ limits. 
%
An odd but reproducible feature, seen in figure \ref{Esucc}, is that for some values of niche overlap there appears to be a minimum of probability at some intermediate carrying capacity. 
This is a low-number effect, and will not be relevant in most ecological systems, though in some situations it may apply, like with nascent cancer strains \cite{Ashcroft2015} or plasmid replacement \cite{Gooding-townsend2015}. 
%Interestingly, at large system size when the parameters are away from the extremes of niche overlap, the invasion probability approaches an asymptotic intermediate value. %This is $E_s=1-a$
%TODO COMM also comment on the badness of that one fit (I think a=0 for both times???)
%
%weird maxima from ordering
%While a reversal of the ordering does not necessitate a maximum mean time, neither is it inconsistent. 
%COMM start more generally; figure seven shows time for failed invasion, has a peak, whatverver
Figure \ref{Tfail} also shows a maximum of mean time conditioned on a failed invasion attempt at intermediate carrying capacity. 
%While this is not inconsistent with the predicted ordering reversal, neither is it necessary. 
%We did not predict this peak, but i
It is consistent with the our expectation of fast times for both small and large $K$ for incomplete niche overlap. 
The maximum appears for all values of $a$ except $a=1$. 
%We do not provide a mechanism to explain this result. 
%We do, however, point out that this observation should be easily testable in a setup with controlled population size and regular genotypic sampling (or phenotypic, if the mutant is distinguishable experimentally). 

\begin{figure}[ht!]
	\centering
	\begin{minipage}{0.49\linewidth}
		\centering
		\includegraphics[width=1.0\linewidth]{fiftyfifty-invtimevK.png}
	\end{minipage}
	\begin{minipage}{0.49\linewidth}
		\centering
		\includegraphics[width=1.0\linewidth]{fiftyfifty-invtimeva.png}
	\end{minipage}
	%  \includegraphics[width=0.9\linewidth]{invasion-time-succ}
	\caption{\emph{Time of a successful invasion.} 
		\emph{Left:} Solid lines are the numerical results, from $a=0$ at the bottom to $a=1$ at top. The WFM result is given by the blue dashed line, and is linear, albeit with a slope that matches poorly with our results. 
		\emph{Right:} The solid blue line shows the results for small carrying capacity ($K=4$), and successive lines are at larger system size, up to $K=256$. The dash dot black line is $1/d_{mut}$. 
	} \label{Tsucc}
\end{figure}%TODO The black dotted line is the expected single logistic limit.

\begin{figure}[h]
	\centering
	\begin{minipage}{0.49\linewidth}
		\centering
		\includegraphics[width=1.0\linewidth]{fiftyfifty-exttimevK.png}
	\end{minipage}
	\begin{minipage}{0.49\linewidth}
		\centering
		\includegraphics[width=1.0\linewidth]{fiftyfifty-exttimeva.png}
	\end{minipage}
	%  \includegraphics[width=0.9\linewidth]{invasion-time-fail}
	\caption{\emph{Time of a failed invasion.}
		\emph{Left:} Solid lines are the numerical results, from $a=0$ mostly being fastest to $a=1$ being slowest, for large $K$. The blue dashed line is WFM result. 
		\emph{Right:} The solid blue line shows the results for small carrying capacity ($K=4$), and successive lines are at larger system size, up to $K=256$. The dash dot black line is $1/d_{mut}$. 
	} \label{Tfail}
\end{figure}

These conditional times are hard to intuit. 
%What this suggests is that, even if failure is likely, it happens quickly, within one or two events. 
Increasing $K$ moves the deterministic fixed point farther away, so we expect longer times, but it also draws the system more strongly, which would imply faster times. 
%nothing exponential
Regardless, all the timescales of invasion are fast:
neither the mean time of a successful invasion nor of a failed attempt grows exponentially with the system size. 
This contrasts with the results of the previous sections, where the mean fixation time is exponential in the system size except when $a$ is exactly one. 
$\tau_{s}$ at complete niche overlap has the fastest scaling, growing linearly with the carrying capacity. 
Whereas competing species will coexist for long times unless niche overlap is complete, the dynamics of the attempted invasion of a dominant species will be fast \cite{invasion is fast}. 
%Anton's comment: need references or explanation for this, rather than just observing
As will be discussed below, these timescales need to be compared against the mutation or immigration timescale to offer some insight on mutation-selection balance. 



\section{Discussion}
Unlike the fixation times of coexisting species in all but complete niche overlap, invasions into the system do not show exponential scaling in any limit. 
%The balance between mutation or immigration coming into the system and these invaders failing to establish themselves determines how diverse a system will be. 
%If the rate in is greater than the mean failure time, the system will diversify. In the other extreme, if the influx rate is lesser even than the mean fixation times of Section 4 then a monoculture is expected. 
%For this reason we have calculated the mean failure time, the mean time of invasion, and the probability of such a success. 
The likelihood of failure grows linearly with niche overlap, for sufficiently large $K$. 
For complete niche overlap the invasion probability goes asymptotically to zero, but it is low even for partially mismatched niches. 
The timescale of a successful invasion varies between linear and logarithmic in the system size. 
The mean time of an unsuccessful invasion is even faster than logarithmic, and for large $K$ it becomes independent of $K$. 
Curiously, these failed invasion attempts are unimodal, at intermediate carrying capacity and niche overlap values. %COMM heat map?
Our results provide a timescale to which the rate of immigration or mutation can be compared. 
If the influx of invaders is slower than the mean time of their failed invasion attempts, each attempt is independent and has the invasion probability we have calculated. 
In the extreme case of this, that is, if the time between invaders is even longer than the fixation times calculated in the previous chapter, then serial monocultures are expected. 
However, if individual invaders arise faster than the time it takes to suppress the previous attempt, the new strains interact with one another in ways beyond the scope of this thesis, leading to greater biodiversity. 

%We have also found that at large $K$ the likelihood of an invasion failing grows linearly with niche overlap, such that a mutant or immigrant is more likely to invade a system if its niche is more dissimilar with that of the established species. 

!!!%should be able to at least estimate steady state biodiversity as a function of mutation/immigration/speciation rate and niche overlap and carrying capacity using the parametrized plots !!!

We can get an idea of what it would be like, having a new immigrant come in before the previous invasion attempt is over, by considering a Moran model with immigration. 
This would correspond to the complete niche overlap limit, such that the population size is roughly constrained to the Moran line. 



\section{Moran Reintroduction}
The Moran model \cite{Moran1962} is a classic urn model used in population dynamics in a variety of ways.
Its most prominent use is in coalescent theory, describing how the relative proportion of genes in a gene pool might change over time. 
But really it can describe any system where individuals of different species/strains undergo strong but unselective competition in some closed or finite ecosystem.

To arrive at the Moran model we must make some assumptions.
Whether these are justified depends on the situation being regarded.
The first assumption is that no individual is better than any other; that is, whether an individual reproduces or dies is independent of its species and the state of the system.
This makes the Moran model a neutral theory, and any evolution of the system comes from chance rather than from selection.

Next we assume that the the population size is fixed, owing to the (assumed) strict competition in the system.
That is, every time there is a birth the system becomes too crowded and a death follows immediately. Alternately, upon death there is a free space in the system that is filled by a subsequent birth.
In the classic Moran model each pair of birth and death event occurs at a discrete time step (cf. the Wright-Fisher model, where each step involves $N$ of these events).
This assumption of discrete time can be relaxed without a qualitative change in results.


\section{Moran Model in More Detail}
In the classic Moran model, each iteration or time step involves a birth and a death event.
Each organism is equally likely to be chosen (for either birth or death), hence a species is chosen according to its frequency, $f=n/N$, where $N$ is the total population and $n$ is the number of organisms of that species.
Note that $N-n$ represents the remainder of the population, and need not all be the same species, so long as they are not the focal species denoted with `$n$'.
The focal species increases in the population if one of its members gives birth while a member of a different species dies; that is, $b(n) = f(1-f)$.
Increase and decrease of the focal species are equally likely, with
%There is a net rate of change, in both increasing and decreasing $n$, of
\begin{equation}
b(n) = f(1-f) = (1-f)f = d(n) = \frac{n}{N}\left(1-\frac{n}{N}\right) = \frac{1}{N^2}n(N-n)
\end{equation}
each time step $\Delta t$.
Each step, the chance that nothing happens is $1-\left(b(n)+d(n)\right) = f^2 + (1-f)^2$.
These are not rates themselves, rather they are the probability of an increase or decrease in the time step.
A straightforward approximation would be to take $\Delta t$ infinitesimal, then $b(n)\Delta t$ and $d(n)\Delta t$ serve as rates of birth and death of the species in a continuous time analogue to the Moran model.

For the record, here is the mean and variance as a function of time.
If the system starts with $n_0$ individuals of the focal species, then there should be
\begin{equation*}
(n_0-1)d(n_0) + (n_0+1)b(n_0) + n_0\big(1-b(n_0)-d(n_0)\big) = n_0 - d(n_0) + b(n_0) = n_0
\end{equation*}
individuals in the next time step as well.
Iterating this calculation gives that the expected value at all times is just the initial population, $\langle n\rangle(t) = n_0$.
Given the delta function initial condition of starting with $n_o$ individuals, the variance should start at zero and grow.
After one time step the second moment is
\begin{equation*}
(n_0-1)^2d(n_0) + (n_0+1)^2b(n_0) + n_0^2\big(1-b(n_0)-d(n_0)\big) = n_0^2 - 2n_0d(n_0) + 2n_0b(n_0) + d(n_0) + b(n_0)
\end{equation*}
and the variance $V_1 = 2b(n_0) = 2d(n_0) = 2f_0(1-f_0)$.
%Because the expectation of $n$ does not change each time step, 
For the variance at time step $k$ we need the variance at $k-1$ and the law of total variance, $E[Var(n_k|n_{k-1})]+Var(E[n_k|n_{k-1}])=Var(n_k)\equiv V_k$.
Recalling $E[n_k|n_{k-1}]=n_{k-1}=n_0$ and $Var(n_k|n_{k-1})=2f_{k-1}(1-f_{k-1})$
\begin{align*}
V_k &= E\left[ 2 f_{k-1}(1-f_{k-1}) \right] + Var(n_{k-1}) \\
    &= 2\langle f_{k-1}\rangle - 2\langle n_{k-1}^2\rangle/N^2 + V_{k-1} \\
    &= 2\langle f_{k-1}\rangle - 2(V_{k-1}+\langle n_{k-1}\rangle^2)/N^2 + V_{k-1} \\
    &= 2\langle f_{k-1}\rangle (1 - \langle f_{k-1}\rangle ) + (1-2/N^2)V_{k-1} \\
    &= V_1 + (1-2/N^2)V_{k-1}.
%     &= V_1 + (1-2/N^2)(V_1 + (1-2/N^2)V_{k-2}) = V_1(1 + (1-2/N^2) + (1-2/N^2)^2) + (1-2/N^2)^3V_{k-3} \\
%     &= V_1(\sum_{i=0}^{k-1} (1-2/N^2)^i)
\end{align*}
Iterating the above and using the geometric series $\sum_{i=0}^{k-1} r^i = (1-r^k)/(1-r)$ gives
\begin{equation*}
V_k = V_1 \big(1-(1-2/N^2)^k\big)/(2/N^2) = n_0(N-n_0) \big(1-(1-2/N^2)^k\big).
\end{equation*}
Notice that as $N\rightarrow\infty$ the variance, a measure of the fluctuations, goes to zero, and the system becomes deterministic. [maybe cf. hardy-weinberg variances]
For finite $N$ the variance goes to $N^2 \, f_0(1-f_0)$ at long times. 
This corresponds to $f_0$ of the probability mass being at $n=N$, and $(1-f_0)$ being at $n=0$, since at long times the system has fixated at one end or the other. 

The system fluctuates until either the species dies (extinction) or all others die (fixation).
Both of these cases are absorbing states, so once the system reaches either it will never change.
Since a species is equally likely to increase or decrease each time step, the model is akin to an unbiased random walk, and therefore the probability of extinction occurring before fixation is just
\begin{equation}
E(n) = 1-n/N = 1-f.
\end{equation}
DERIVE THIS!!!!!!
The first passage time, however, does not match a random walk, as there is a probability of no change in a time step, and this probability varies with $f$.
DERIVE THE FIRST PASSAGE TIMES AS WELL (conditional and un?!?!)

%The system fluctuates as long as the number of organisms of the species of interest is neither none (extinction) nor all (fixation).
We define the unconditioned first passage time $\tau(n)$ as the time the system takes, starting from $n$ organisms of the focal species, to reach either fixation \emph{or} extinction.
It can be calculated by regarding how the mean from one starting position $n$ relates to the mean of its neighbours.
%(This is similar to the backward master equation.)
\begin{equation}
\tau(n) = \Delta t + d(n)\tau(n-1) + \left(1-b(n)-d(n)\right)\tau(n) + b(n)\tau(n+1)
\end{equation}
Subbing in the values of the `birth' and `death' rates and rearranging this gives
\begin{equation}
\tau(n+1) - 2\tau(n) + \tau(n-1) = -\frac{\Delta t}{b(n)} = -\Delta t\frac{N^2}{n(N-n)},
\end{equation}
or
\begin{equation}
\tau(f+1/N) - 2\tau(f) + \tau(f-1/N) = -\Delta t\frac{1}{f(1-f)}.
\end{equation}
If we approximate the LHS of the above with a double derivative (ie. $1\ll N$) we get
\begin{equation}
\frac{\partial^2\tau}{\partial n^2} = -\Delta t\,N\left(\frac{1}{n}+\frac{1}{N-n}\right)
\end{equation}
Double integrate and use the bounds $\tau(0) = 0 = \tau(N)$ to get
\begin{equation}
\tau(n) = -\Delta t\,N^2\left(\frac{n}{N}\ln\left(\frac{n}{N}\right)+\frac{N-n}{N}\ln\left(\frac{N-n}{N}\right)\right).
\end{equation}
Note that we didn't need to use the large $N$ approximation: there is an exact solution:
\begin{equation}
\tau(n) = \Delta t\,N\left(\sum_{j=1}^n\frac{N-n}{N-j} + \sum_{j=n+1}^N\frac{n}{j}\right).
\end{equation}


\section{Moran With Immigration}
Previous sections have stated that different dynamics are expected depending on a comparison of timescales. 
If new species enter the system faster than they go extinct, the biodiversity should increase to some steady state. 
Conversely, if extinction is much more rapid than speciation, a monoculture is expected in the system. 
Whether the monocultural system contains the same species over multiple invasion attempts or whether it experiences sweeps, changing from a monoculture of one species to the next, depends on the probability of a successful invasion. 
To arrive at some analytic solutions, we will treat a simplified model. 

The basis of the following model is that of Moran, with its finite population size and discrete time steps, although we will relax the latter constraint. 
For comparison, Crow and Kimura \cite{Crow1956,Kimura1983} treat the problem with both continuous time and continuous populations (ie. population densities), arriving at some numerical results but not much else...
Our inspiration is an /interesting/ work from the Gore lab \cite{Vega2017}, measuring the gut microbiome of bacteria-consuming \emph{C. elegans} grown in a 50-50 environment of two strains of fluorescently-labeled but otherwise identical \emph{E. coli}. 
After an initial colonization period, each nematode has a stable number of bacteria in their gut, presumably from a balance of immigration, birth, and death/emigration. 
The researchers find a distribution of populations depending on the comparison of two experimental timescales. 

For the model in this section, consider a focal species of $n$ organisms, with the remaining $N-n$ organisms being of a different strain (or strains). 
Again we define a fractional abundance $f=n/N$. 
%Consider a regular Moran population, but now there can be immigration into the system. 
%Biologically this can correspond to eg. new bacteria being drawn into a microbiome or new mutants arising within a population. 
Traditionally the Moran population is thought to be some isolated population, and immigrants come from some metapopulation of larger size and diversity. 
We shall see if the Moran population acts as a reservoir, and generally what its dynamics are. 
The metapopulation has the same species we were originally talking about, with $m$, $M$ and $g$ analogous to $n$, $N$ and $f$. 
That is, assume the immigrant into the Moran population is a member of the focal speciest with probability $g$, and not that species with probability $1-g$. 
In theory $g$ should be a random number drawn from the probability distribution associated with some evolving metapopulation, but for now we will take it to be fixed. That is, we assume that the metapopulation changes much slower than the Moran population of interest. 
In the analogy of the Gore experiment, the system of interest is the nematode gut, and the metapopulation is the environment in which the nematode lives (and eats). 
The consumption of one bacterium will influence the gut microbiome while having a negligible effect on the external environment. 

Suppose immigration acts like birth in the Moran model. 
That is, $\nu$ of the time an immigrant comes in instead of a birth event occurring. 
Death occurs as normal. 
Then we have the following possibilities:
\begin{center}
	\begin{tabular}{l|c|l}
		transition		& function	& value \\
		\hline
		$n$ $\rightarrow$ $n+1$	& $b(n)$	& $f(1-f)(1-\nu) + \nu g(1-f)$ \\
		$n$ $\rightarrow$ $n-1$	& $d(n)$	& $f(1-f)(1-\nu) + \nu (1-g)f$ \\
		$n$ $\rightarrow$ $n$	& $1-b(n)-d(n)$	& $\left(f^2+(1-f)^2\right)(1-\nu) + \nu\left(gf+(1-g)(1-f)\right)$
	\end{tabular}
\end{center}
Note that the birth and death rates are no longer the same as each other (as they are, in the classical Moran model); there is a bias in the system, toward $g$. 
Just as with the classical Moran model, strictly speaking $b$ and $d$ are probabilities rather than rates. 
The continuous time model, which well approximates the discrete time Moran, is attained by calling $b$ and $d$ rates and taking $\Delta t$ to zero. 

%Just as before from the backwards master equation you can write
%\begin{equation}
% \tau(n) = \Delta t + d(n)\tau(n-1) + \left(1-b(n)-d(n)\right)\tau(n) + b(n)\tau(n+1)
%\end{equation}
%but you don't want to do that.  
%You could as before approximate this as a differential equation, but the problem is that the bounds won't make sense.  

If a new mutant or immigrant species is unlikely to enter again (ie. if $g\simeq 0$) then this is close to the regular Moran model, and will not be treated further here. %!!! is tihs necessary?
The system then corresponds to the regular Moran model presented in the introduction. 
%A similar idea is considered in our paper, in preparation. 
Here we regard the case where it is possible to draw in the species of interest from the metacommunity, before it goes extinct in the focus community (ie. $\nu g \gg 1/\tau$). %reservoir
Since there will be always be immigration, the system will never truly fixate, as there will always be immigrants of the `extinct' species to be reintroduced to the population.  
Rather, the system will settle on a stationary distribution. 
The process will have the master equation $\frac{d\,P_n(t)}{dt} = P_{n-1}(t)b(n-1) + P_{n+1}(t)d(n+1) - \big(b(n)+d(n)\big)P_n(t)$,
%\begin{equation} \label{master-eqn3}
%\frac{d\,P_n(t)}{dt} = P_{n-1}(t)b(n-1) + P_{n+1}(t)d(n+1) - \big(b(n)+d(n)\big)P_n(t)
%\end{equation}
which gives a difference relation when the time derivative is set to zero. 
Since the system is constrained between $0$ and $N$ we normalize the finite number of probabilities and sum them to unity to get
\begin{equation}
\widetilde{P}_n = \frac{q_n}{\sum_{i=0}^\infty q_i}
\end{equation}
where
\begin{align*}
 q_0 &= \frac{1}{b(0)} = \frac{1}{\nu g} \\
 q_1 &= \frac{1}{d(1)} = \frac{N^2}{(N-1)(1-\nu) + \nu N(1-g)} \\
 q_i &= \frac{b(i-1)\cdots b(1)}{d(i)d(i-1)\cdots d(1)}, \text{  } i>1 \\
     &= \frac{1}{d(i)}\prod_{j=1}^{i-1}\frac{b(j)}{d(j)}
\end{align*}
recalling that $\frac{b(i)}{d(i)} = \frac{i(N-i)(1-\nu) + \nu Ng(N-i)}{i(N-i)(1-\nu) + \nu N(1-g)i}$.
%\begin{equation*}
%\frac{b(i)}{d(i)} = \frac{i(N-i)(1-\nu) + \nu Ng(N-i)}{i(N-i)(1-\nu) + \nu N(1-g)i}. 
%\end{equation*}
%This is long and ugly but nevertheless gives some semblance of an analytic solution in Mathematica. 
%
%Specifically, $q_n = \frac{Pochhammer[1 - N, -1 + n] Pochhammer[1 - (g N \nu)/(-1 + \nu), -1 + n]}{(n (-n + N) (1 - \nu) + (1 - g) n N \nu) \Gamma(n) Pochhammer[(-1 + N + \nu - g N \nu)/(-1 + \nu), -1 + n]}$ and the sum of these is the normalization $\sum q_i = (-(-1 + N^2) (-1 + N + \nu - g N \nu + g N^2 \nu) + (1 - \nu + N (-1 + g \nu)) Hypergeometric2F1[-N, -((g N \nu)/(-1 + \nu)), (-1 + N + \nu - g N \nu)/(-1 + \nu), 1])/(g N^2 \nu (1 - \nu + N (-1 + g \nu)))$ which together gives $\widetilde{P}_n$. 
%$Pochhammer[a,n] = (a)_n = \Gamma(a+n)/\Gamma(a)$
%$\Gamma(n) = (n-1)! = \int_0^\infty t^{n-1}e^{-t}dt$
%$Hypergeometric2F1[a,b;c;z] = \frac{\Gamma(c)}{\Gamma(b)\Gamma(c-b)} \int_0^1 \frac{t^{b-1}(1-t)^{c-b-1}}{(1-t z)^{a}}dt = \sum_{n=0}^\infty \frac{(a)_n (b)_n}{(c)_n}\frac{z^n}{n!} = (1-z)^{c-a-b} _2F_1(c-a,c-b;c;z)$
The unnormalized steady-state probability can be written compactly as%Specifically,
%\begin{equation*}
% q_n = \frac{N^2 Pochhammer[1 - N, -1 + n] Pochhammer[1 - (g N \nu)/(-1 + \nu), -1 + n]}{(n (-n + N) (1 - \nu) + (1 - g) n N \nu) \Gamma(n) Pochhammer[(-1 + N + \nu - g N \nu)/(-1 + \nu), -1 + n]}
%\end{equation*}
%\begin{equation*}%this is definitely awkward and possibly wrong
%q_n = \frac{ N^2 \Gamma(N+n-2) \Gamma\left(n+\frac{g N\nu}{1-\nu}\right) \Gamma\left(\frac{N+\nu-1-g N\nu}{1-\nu}\right) }{ (n(N-n)(1-\nu)+(1-g)n N\nu) \Gamma(n) \Gamma(N-1) \Gamma\left(1+\frac{g N\nu}{1-\nu}\right) \Gamma\left(\frac{N+(n-2)(1-\nu)-g N\nu}{1-\nu}\right)}
%\end{equation*}
\begin{equation*}%right from b/d
q_n = \frac{ N^2\Gamma(N) \Gamma\left(n+\frac{g N\nu}{1-\nu}\right) \Gamma\left(N-n+1+\frac{(1-g) N\nu}{1-\nu}\right) }{ \big(n(N-n)(1-\nu)+(1-g)n N\nu\big) \Gamma(n) \Gamma(N-n+1) \Gamma\left(1+\frac{g N\nu}{1-\nu}\right) \Gamma\left(N+\frac{(1-g) N\nu}{1-\nu}\right)}
\end{equation*}
%\begin{equation*}%right from b/d
%q_n = \frac{ N^2(N-1)! \left(n-1+\frac{g N\nu}{1-\nu}\right)! \left(N-n+\frac{(1-g) N\nu}{1-\nu}\right)! }{ \bigg(n(N-n)(1-\nu)+(1-g)n N\nu\bigg) (n-1)! (N-n)! \left(\frac{g N\nu}{1-\nu}\right)! \left(N-1+\frac{(1-g) N\nu}{1-\nu}\right)!}
%\end{equation*}
%which, under the assumption of small speciation $\nu$, gives
%\begin{equation*}
%q_n \approx \frac{ \Gamma(N+n-2) \Gamma(n+g N\nu) \Gamma(N+\nu-1-g N\nu) }{ (n(N-n+(1-g) N\nu) \Gamma(n) \Gamma(N-1) \Gamma(1+g N\nu) \Gamma(N+n-2-g N\nu)};
%\end{equation*}
and the sum of these is the normalization
%\begin{equation*}
% \sum q_i = \frac{(-1 + N^2) (-1 + N + \nu - g N \nu + g N^2 \nu) + (N (1 - g \nu) - (1 - \nu)) 2F1[-N, \frac{g N \nu}{1 - \nu}; \frac{-1 + N + \nu - g N \nu}{-1 + \nu}; 1]}{g N^2 \nu (N (1 - g \nu) - (1 - \nu))}
%\end{equation*}
%\begin{equation*}
%\sum q_i = \frac{(-1 + N^2) (-1 + N + \nu - g N \nu + g N^2 \nu) + (N (1 - g \nu) - (1 - \nu))}{g N^2 \nu (N (1 - g \nu) - (1 - \nu))}
%\frac{\Gamma[\frac{N(1-g\nu) + 1-\nu}{1-\nu}]\Gamma[\frac{1 - \nu - N\nu}{1-\nu}]}{\Gamma[\frac{N\nu(g-1)+1-\nu}{1-\nu}]\Gamma[\frac{-N+1-\nu}{1-\nu}]}
%\end{equation*}
%hypergeometric is defined as 2F1(a,b,c,z)=sum_n=0^\infty \frac{\Gamma(a+n)\Gamma(b+n)\Gamma(c)}{\Gamma(a)\Gamma(b)\Gamma(c+n)}\frac{z^n}{n!}
% $\sum q_i = _2F_1(-N,g N \nu/(1-\nu); 1-N(1-g\nu)/(1-\nu); 1)/g\nu$ which follows from the hypergeometric definition and $q_i$  %seems close to legit with definition of q_i, 2F1, but it requires writing (d-n)!/(d-1)! = (-1)^{n-1}(-d)!/(n-d-1)! ish
\begin{equation*}
\sum q_i = \frac{1}{g\nu} \frac{\Gamma[1-\frac{N(1-g\nu)}{1-\nu}]\Gamma[N+1-\frac{N}{1-\nu}]}{\Gamma[N+1-\frac{N(1-g\nu)}{1-\nu}]\Gamma[1-\frac{N}{1-\nu}]}
%         = \frac{1}{g\nu} \frac{(-\frac{N(1-g\nu)}{1-\nu})!(-\frac{N\nu}{1-\nu})!}{(-\frac{N(1-g)\nu}{1-\nu})!(-\frac{N}{1-\nu})!}
\end{equation*}
which follows formally from the definition of the hypergeometric function $_2F_1$. Together these give $\widetilde{P}_n$. 
\iffalse
But I should be careful, because I think I summed this to infinity, rather than to $N$ - checked; it makes no difference apparently (and anyway assume $q_{n>N}=0$). \\
$Pochhammer[a,n] = (a)_n = \Gamma(a+n)/\Gamma(a)$ \\
$\Gamma(n) = (n-1)! = \int_0^\infty t^{n-1}e^{-t}dt$ \\
$\ln(-x)=\ln(x)+i\pi$ [yes] for $x>0$ and $\Gamma(-x)=(-(x+1))!=(x+1)!+i\pi=?\Gamma(x+2)?$ [no] - I'm not sold that this line is true!!! \\
Stirling: $\ln n! \approx n \ln n - n$ so $\ln \Gamma(n) = \ln n!/n \approx n\ln n - 2n$ \\
$Hypergeometric2F1[a,b;c;z] = \frac{\Gamma(c)}{\Gamma(b)\Gamma(c-b)} \int_0^1 \frac{t^{b-1}(1-t)^{c-b-1}}{(1-t z)^{a}}dt = \sum_{n=0}^\infty \frac{(a)_n (b)_n}{(c)_n}\frac{z^n}{n!} = (1-z)^{c-a-b} _{2}F_1(c-a,c-b;c;z)$ \\
$_2F_1(a,b;c;1) = \frac{\Gamma(c)\Gamma(c-a-b)}{\Gamma(c-a)\Gamma(c-b)}$ \\
Since $q_1=1$ the stationary probability at 1 is $\widetilde{P}_1$; this gives the flux to 0, hence the exit times. 
Similarly $n=N-1$ should be the other place whence it exits (but it's not clear whether $q_{N-1}=1$). 
\fi
See figure \ref{stationary-fig2} for a visualization of the steady-state probability distribution for different immigration/speciation rates. 
%\begin{figure}[ht]
%	\centering
%	\includegraphics[scale=1]{Moran-withimmigration-stationaryprobability}
%	\caption{PDF of stationary Moran process due to immigration. $g=0.1$, $N=50$, $\nu=0.01$. } \label{stationary-fig}
%\end{figure}
\begin{figure}[ht]
	\centering
	\includegraphics[width=\textwidth]{Moran-withimmigration-stationaryprobability2}
	\caption{PDF of stationary Moran process due to immigration. $g=0.4$, $N=100$, $N\nu$ is given by the colour; red is 10, orange is 5, green is 3, blue is 2, purple is 1, and grey is 0.2. Notice that the curvature of the distribution inverts around $\nu=2/N$. } \label{stationary-fig2}
	%N.B. note that it's plotting from n=1 to n=100, so it won't look quite symmetric
\end{figure}

We can easily calculate the mean and variance as a function of time before reaching steady state. 
If the mean $\mu$ at some time step $k$ has $\mu_k=n_k$ individuals, then after one time step there should be $\mu_{k+1}= n_k - d(n_k) + b(n_k) = n_k + \nu(g-f_k)$ individuals. 
That is, $\mu_{k+1}-\mu_k = \nu(g-\mu_k/N)$. 
This is solved by 
\begin{equation*}
 \mu_k = \langle n\rangle(k) = g N \left( 1 - (1-n_0)(1-\nu/N)^k\right).
\end{equation*}
At long times the mean fraction $f$ matches that of the metapopulation, $g$. 
To get the an approximation of the variance, we will consider the continuous time analogue. 
First, the mean evolves as $\partial_t\mu = \langle b(n)-d(n)\rangle = \nu\left(g-\mu/N\right)$, which has the solution $\mu(t) = g N  + (\mu_0-g N)e^{-\nu t/N}$, and the timescale is set by $\nu/N$. 
The dynamical equation for the second moment is
\begin{align*}
 \partial_t\langle n^2\rangle &= 2\langle n b(n) - n d(n)\rangle + \langle b(n) + d(n)\rangle \\
                              &= 2\nu \left( g \mu - \langle n^2\rangle/N\right) + 2(1-\nu)\left(N\mu-\langle n^2\rangle\right)/N^2 + \nu(\mu + g N - 2 \mu g)/N
\end{align*}
which is an inhomogeneous linear differential equation. 
The solution is long but not complicated. 
Recalling that $\sigma^2(t) = \partial_t\langle n^2\rangle(t) - \mu^2(t)$ I write the variance as
%\begin{equation*}
% \text{Var} = \frac{N e^{-\frac{2 t ((N-1) \nu+1)}{N^2}} \left(\mu_0 ((N-1) \nu+1) (\nu (2 g (N-1)-1)+2) \left(e^{\frac{t ((N-2) \nu+2)}{N^2}}-1\right)+g N \left(((N-1) \nu+1) (\nu (2 g (N-1)-1)+2) \left(-e^{\frac{t ((N-2) \nu+2)}{N^2}}\right)+((N-2) \nu+2) (g (N-1) \nu+1) e^{\frac{2 t ((N-1) \nu+1)}{N^2}}+(N-1) \nu (\nu (g N-1)+1)\right)\right)}{((N-2) \nu+2) ((N-1) \nu+1)}-e^{-\frac{2 \nu t}{N}} \left(g N \left(e^{\frac{\nu t}{N}}-1\right)+\mu_0\right)^2. 
%\end{equation*}
\begin{equation*}
 \sigma^2(t) = \sigma^2(\infty) + A\exp\{-\frac{\nu}{N}t\} - B\exp\{-2\frac{\nu}{N}t\} + C\exp\{-\frac{2}{N}\left(\nu+\frac{(1-\nu)}{N}\right)t\}
\end{equation*}
where $A=\big(1+g\nu-g(1-\nu)/N\big)N^2\frac{\mu_0-gN}{N\nu+2(1-\nu)}$, $B=(gN-\mu_0)^2$, and $C$ is an integration constant; $C = \sigma^2(0) - \sigma^2(\infty) + (gN-\mu_0)^2 + (gN-\mu_0)(2-\nu)(1-2g)/\big(N\nu+2(1-\nu)\big)$ if the initial variance is $\sigma^2(0)$. 
$\sigma^2(\infty) = g(1-g) N^2\frac{1}{1+\nu(N-1)}$ is the long time, steady state variance of the system. 
%The steady state variance is $N^2\frac{g(1+g \nu(N-1))}{1+\nu(N-1)}$. 
%Or is it $N^2\frac{g(1-g)}{1+\nu(N-1)}$?

Notice that for $g=0,1$ the long term variance $\sigma^2(\infty)$ goes to zero. 
This contrasts with the results of the Moran model without immigration, where a fraction of instances fixate with the focal species and in the remaining fraction that species goes extinct, in proportion to its initial abundance. 
Having a supply of immigrants destabilizes one of these absorbing states, such that the ultimate fate is either none of the focal species for $g=0$ or only the focal species for $g=1$. 
The memory of the initial abundance does not affect these results at long times. 
However, if the immigration rate is truly small, such that $N\nu\ll 1$, we recover similar results to the no immigration case. 
Instead of $f_0(1-f_0)N^2$ we get $\sigma^2(\infty) \approx g(1-g) N^2$, with the metapopulation focal species abundance $g$ acting as the initial abundance. 
This is because the fixation time of the Moran model, which goes like $N$, is much faster than the immigration time $1/\nu$. 
Upon entry of a new immigrant the Moran model fixates as usual, in proportion to either $1/N$ or $(N-1)/N$, depending on the species of the immigrant, which in turn is governed by the metapopulation abundance $g$. 
Each iteration goes one way or the other, typically to the closest extreme, which a fraction $g$ of the time is the focal species, hence $\sigma^2(\infty) \approx g(1-g) N^2$. 
The fixation need not happen more rapidly than the time between successive immigration events, however. 
When $N\nu\gg 1$ the system is still evolving when a new immigrant is introduces, which acts to keep the probability distribution near $g$ and away from fixation. 
In this limit the long term variance tends to $\sigma^2(\infty) \approx g(1-g) N/\nu$. 
The argument for having no variance with $g=0,1$ still stands. %, but now the variance is much smaller for intermediate $g$... or larger?
But now that the immigration rate is no longer negligibly small, it shows up in the variance. 
For a fixed system size $N$, increasing the immigration rate decreases the variance, as the system is drawn more toward the metapopulation abundance and away from the edges. 

The variance limits, and indeed figure \ref{stationary-fig2}, suggest that there are two regimes of the Moran model with immigration. 
At low immigration rate the system undergoes a series of fixations punctuated by the occasional immigrant. It spends most of its time resting in the fixated state, rarely seeing a new immigrant which quickly either dies out or takes over in a new fixation. 
When immigration is common the system is tied to the metapopulation, and deviations away from the metapopulation abundance are suppressed. 
Probability gathers near the mean value $gN$. 
These regimes will be investigated further in the following paragraphs. 

A quantity similar to the mean is the extremum of the distribution, which for large immigration corresponds to the mode of the system. 
The extremum occurs when $\partial_n \widetilde{P}_n = 0$ but for ease note that $\partial_n \widetilde{P}_n = \partial_n q_n/\sum_i q_i = \partial_n q_n = q_n \partial_n \ln(q_n)$ therefore I can instead calculate the value which gives $\partial_n \ln(q_n)=0$. 
First,
\begin{align*}
 \ln(q_n) &= 2\ln[N] - \ln\big[n(N-n)(1-\nu)+(1-g)n N\nu\big] + \ln[(N-n)!] + \ln\big[\left(n-1+\nu g N/(1-\nu)\right)!\big] + \ln\big[\left(N-n+\nu(1-g)N/(1-\nu)\right)!\big] - \ln[(N-n)!] - \ln[(n-1)!] - \ln\big[\left(\nu g N/(1-\nu)\right)!\big] - \ln\big[\left(N-1+\nu(1-g)N/(1-\nu)\right)!\big] \\
          &\approx 2\ln[N] - \ln\big[n(N-n)(1-\nu)+(1-g)n N\nu\big] + (N-n)\ln[(N-n)] + \left(n-1+\nu g N/(1-\nu)\right)\ln\big[\left(n-1+\nu g N/(1-\nu)\right)\big] + \left(N-n+\nu(1-g)N/(1-\nu)\right)\ln\big[\left(N-n+\nu(1-g)N/(1-\nu)\right)\big] - (N-n)\ln[(N-n)] - (n-1)\ln[(n-1)] - \left(\nu g N/(1-\nu)\right)\ln\big[\left(\nu g N/(1-\nu)\right)\big] - \left(N-1+\nu(1-g)N/(1-\nu)\right)\ln\big[\left(N-1+\nu(1-g)N/(1-\nu)\right)\big]
\end{align*}
where I have employed the Stirling approximation $\ln[x!] = x\ln[x] - x + O(1/x)$. 
Setting $\partial_n \ln[q_n]=0$ gives
\begin{align*}
 \ln\left[ \frac{(N-n)(n-1+\nu g N/(1-\nu))}{(n-1)(N-n+\nu(1-g)N/(1-\nu))}\right]  &= \frac{-2n+N(1-\nu-g\nu)/(1-\nu)}{n\left(-n+N(1-\nu-g\nu)/(1-\nu)\right)} \\
=\ln\left[ \frac{(1-f)(f-\gamma+\epsilon g)}{(f-\gamma)(1-f+\epsilon(1-g))}\right] &= \gamma\frac{1-2f-\epsilon g}{f\left(1-f-\epsilon g\right)}
\end{align*}
where $\gamma = 1/N$ and $\epsilon = \nu/(1-\nu)$, and recalling that $f=n/N$. 
I expect that $\gamma$ and $\epsilon$ are small parameters, and as such I expand in them. 
The right-hand side obviously is to $O(\gamma)$ lowest, followed by $O(\epsilon\gamma)$. 
The left-hand side has an infinite series in $\epsilon$ starting at $O(\epsilon^1)$, before picking up $O(\epsilon\gamma)$ terms. 
Keeping only the $O(\epsilon^1)$ and $O(\gamma^1)$ terms gives
\begin{equation}
	f^* = \frac{1-g\epsilon/\gamma}{2-\epsilon/\gamma}. % \text{  or  } n^* = \frac{N-gN\epsilon/\gamma}{2-\epsilon/\gamma}
\end{equation}
Once again it is clear that there are two regimes. 
When immigration is small, $\epsilon/\gamma = N\nu \ll 1$, and the maximum or mode of the distribution matches with the mean. 
The bulk of the probability is centred near $g N$. 
But in the opposite limit, when the probability is concentrated at zero and one, the minimal value is half way between these two. 
No conclusion should be drawn from this, as it is the point of least probability, and anyway the mean remains $gN$. 

The question remains, how does the distribution switch between these two qualitatively different regimes. 
To observe this I calculate the curvature of the extremum point. 
It goes from positive to negative as the immigration rate is increased, and there must be a critical value at which it changes sign. 
This is found when $\partial_n^2 q_n=0$. 
I note that $\partial_n^2 q_n=\partial_n \big(q_n \partial_n \ln[q_n] \big) = q_n \big( (\partial_n \ln[q_n])^2 + \partial_n^2 \ln[q_n] \big)$. 
$q_n>0$ and $\partial_n \ln[q_n]=0$ at the extremum so an equivalent problem is to find the parameter values that make $\partial_n^2 \ln[q_n]=0$ at the extremum. 
\begin{align*}
 \partial_n^2 \ln[q_n] &= \frac{\gamma}{f-1} + \frac{\gamma}{f-\gamma+\epsilon g} + \frac{\gamma}{\gamma-f} + \frac{\gamma}{1-f+\epsilon(1-g)} + \frac{2\gamma^2}{f\big(1-f+\epsilon(1-g)\big)} + \frac{\gamma^2\big(2f-1-\epsilon(1-g)\big)}{f\big(1-f+\epsilon(1-g)\big)^2} + \frac{\gamma^2\big(1-2f+\epsilon(1-g)\big)}{f^2\big(1-f+\epsilon(1-g)\big)}
\end{align*}
%Substituting $f^*$, expanding to lowest order, and setting equal to zero gives
Substituting $f^*$ and expanding to lowest order makes the sign proportional to
\begin{equation*}
% -\epsilon^2\left(4\gamma/\epsilon - 4g+1 - \sqrt{16g^2+1}\right)\left(4\gamma/\epsilon - 4g+1 + \sqrt{16g^2+1}\right) = 0
 4 - 2\epsilon/\gamma - \big(1-4g(1-g)\big)\big(\epsilon/\gamma\big)^2
\end{equation*}
Also finding the mode and inversion values...!!!

Figure \ref{stationary-fig2} gives the probability distribution of the species of interest averaged over long times, but does not allow us to infer anything about the time scales or dynamics of the system. 
To do so, we must look at a slightly modified problem, with modified transition rates such that $b(0)=d(N)=0$. 
This allows us to find the mean first passage time to species fixation or extinction, recognizing that this will only be a temporary state. 
%Since we have modified the transition rates at just two points, these don't show up when you use the approximate differential equation.  
The technique follows that laid out in the introduction. 
As a brief reminder, define $E_i$ as the probability that the focal species goes extinct in this modified system with absorbing states at $n=0$ and $n=N$, ie. the system goes to the former before the latter, given that it starts at $n=i$. 
Then $E_i = \frac{b(i)}{b(i)+d(i)}E_{i+1} + \frac{d(i)}{b(i)+d(i)}E_{i-1}$. 
Further define $S_i = \frac{d(i)\cdots d(1)}{b(i)\cdots b(1)}$. 
Then 
\begin{equation} \label{extnprob}
E_{i} = \frac{\sum_{j=i}^{N-1}S_j}{1+\sum_{j=1}^{N-1}S_j}. 
\end{equation}
See figure \ref{extnprobfig} for a graphical representation of the results. 
As with the stationary distribution, the extinction probabilities can be written explicitly, but the solution has an even less nice form. 
%Nevertheless, let's try:
%\begin{equation*}
%content...
%\end{equation*}
\begin{figure}[ht]
	\centering
	\includegraphics[scale=1]{Moran-withimmigration-extinctionprobability}
	\caption{Probability of first going extinct, given starting population/fraction. $g=0.1$, $N=50$, $\nu=0.01$. Grey is regular Moran results without immigration. } \label{extnprobfig}
\end{figure}
Comment here? Or later...!!!

Similar to the extinction probabilities, we can write unconditioned mean first passage times to get
%\begin{equation}
%\tau[i] = \frac{\Delta t}{b(i)+d(i)} + \frac{b(i)}{b(i)+d(i)}\tau[i+1] + \frac{d(i)}{b(i)+d(i)}\tau[i-1]. 
%\end{equation}
%As before this can be rearranged to give
\begin{equation}
\tau[i] = \sum_{k=1}^{N-1}q_k + \sum_{j=1}^{i-1}S_{j}\sum_{k=j+1}^{N-1}q_k. 
\end{equation}
%where
%\begin{equation*}
%q_i = \frac{b(i-1)\cdots b(1)}{d(i)d(i-1)\cdots d(1)}. 
% \text{  and  } S_i = \frac{d(i)\cdots d(1)}{b(i)\cdots b(1)}. 
%\end{equation*}
%so ultimately
%$\tau[n]=-\frac{N^2}{-u+N (g u-1)+1}+\sum _{j=2}^{n-1} \frac{\Gamma (j+1) \left(\frac{-g u N+N+u-1}{u-1}\right)_j \left(\frac{g (-u+N (g u-1)+1) (1-N)_{N-1} \left(1-\frac{g N u}{u-1}\right)_{N-1}+(g-1) \Gamma (N) \left(g u N^2-g u N+N+u+(-u+N (g u-1)+1) \, _2F_1\left(-N,-\frac{g N u}{u-1};\frac{-g u N+N+u-1}{u-1};1\right)-1\right) \left(\frac{-g u N+N+u-1}{u-1}\right)_{N-1}}{(g-1) g u (-u+N (g u-1)+1) \Gamma (N) \left(\frac{-g u N+N+u-1}{u-1}\right)_{N-1}}-\frac{g N^2 u (-u+N (g u-1)+1) \, _3F_2\left(1,j-N+1,\frac{u j}{u-1}-\frac{j}{u-1}+\frac{u}{u-1}-\frac{g N u}{u-1}-\frac{1}{u-1};j+2,\frac{u j}{u-1}-\frac{j}{u-1}+\frac{2 u}{u-1}+\frac{N}{u-1}-\frac{g N u}{u-1}-\frac{2}{u-1};1\right) (1-N)_j \left(1-\frac{g N u}{u-1}\right)_j-(j+1) (-g u N+N+j (u-1)+u-1) \Gamma (j+1) \left(g u N^2-g u N+N+u+(-u+N (g u-1)+1) \, _2F_1\left(-N,-\frac{g N u}{u-1};\frac{-g u N+N+u-1}{u-1};1\right)-1\right) \left(\frac{-g u N+N+u-1}{u-1}\right)_j}{g (j+1) u (-u+N (g u-1)+1) (-u j+j-u+N (g u-1)+1) \Gamma (j+1) \left(\frac{-g u N+N+u-1}{u-1}\right)_j}\right)}{(1-N)_j \left(1-\frac{g N u}{u-1}\right)_j}+\frac{g (-u+N (g u-1)+1) (1-N)_{N-1} \left(1-\frac{g N u}{u-1}\right)_{N-1}+(g-1) \Gamma (N) \left(g u N^2-g u N+N+u+(-u+N (g u-1)+1) \, _2F_1\left(-N,-\frac{g N u}{u-1};\frac{-g u N+N+u-1}{u-1};1\right)-1\right) \left(\frac{-g u N+N+u-1}{u-1}\right)_{N-1}}{(g-1) g u (-u+N (g u-1)+1) \Gamma (N) \left(\frac{-g u N+N+u-1}{u-1}\right)_{N-1}}+\frac{(-g u N+N+u-1) \left(g (-u+N (g u-1)+1) (1-N)_{N-1} \left(1-\frac{g N u}{u-1}\right)_{N-1}+(g-1) \Gamma (N) \left(g u N^2-g u N+N+u+(-u+N (g u-1)+1) \, _2F_1\left(-N,-\frac{g N u}{u-1};\frac{-g u N+N+u-1}{u-1};1\right)-1\right) \left(\frac{-g u N+N+u-1}{u-1}\right)_{N-1}\right)}{(g-1) g (N-1) u ((g N-1) u+1) (-u+N (g u-1)+1) \Gamma (N) \left(\frac{-g u N+N+u-1}{u-1}\right)_{N-1}}$
Note that this should go to zero at both $n=0$ and $n=N$, since it is unconditioned. 
Again, there is a closed form, but it is a sum of hyperbolic functions and does not possess intuitable limits. 
It is approximated numerically and displayed graphically in figure \ref{extntimefig}. 
\begin{figure}[ht]
	\centering
	\includegraphics[scale=1]{Moran-withimmigration-extinctiontimes}
	\caption{Mean time to either fixation or extinction, given starting population/fraction. $g=0.1$, $N=50$, $\nu=0.01$. Grey is regular Moran results without immigration. } \label{extntimefig}
\end{figure}
Comments???!!!

Keeping with the artificial stoppage when the focal population reaches $0$ or $N$ individuals, we calculate the conditional times, respectively to extinction and to fixation. 
As before, the extinction probability is given by equation \ref{extnprob}. 
%This is equivalent to solving
%\begin{equation*}
%M_b \cdot \vec{E_i} = -\vec{\delta}_{1,i}d(1),
%\end{equation*}
%following Iyer-Biswas and Zilman \cite{Iyer-Biswas2015}. 
%We can solve for the conditional extinction time from
%\begin{equation}
%M_b \cdot \vec{\phi_i} = -\vec{E_i}. 
%\end{equation}
%Here $\phi_i \equiv E_i \theta_i$ (not a dot product, just multiplication of elements), where $\theta_i$ is the conditional extinction time. 
%These equations were derived for a continuous time process, rather than the discrete one of the Moran model, but the results are largely comparable. 
%%In fact, because we are calculating the mean time, I think it gives the same results. 
%Just like for unconditioned extinction times (in the discrete case) you have,
%\begin{equation*}
%\tau_e[n_0+1] - \tau_e[n_0] = \left(\tau_e[1] - \sum_{i=1}^{n_0}q_i\right)S_{n_0},
%\end{equation*}
%so too can you write
%\begin{equation}
%\phi[n+1] - \phi[n] = \left(\phi[1] - \sum_{i=1}^{n}q_iE_i\right)S_{n},
%\end{equation}
%where $\phi_i = E_i\theta_i$, and with the reminder that
%\begin{equation*}
%q_i = \frac{b(i-1)\cdots b(1)}{d(i)d(i-1)\cdots d(1)} \text{  and  } S_i = \frac{d(i)\cdots d(1)}{b(i)\cdots b(1)}. 
%\end{equation*}
Similar to the continuous time solutions presented in the introduction,%!!!!!!!!!!\ref{?}
the conditional extinction time can be written as
\begin{equation}
\phi[n] = \phi[1] + \sum_{j=1}^{n-1}\left(\phi[1] - \sum_{i=1}^{j}q_iE_i\right)S_{j}.  
\end{equation}
We have the other boundary condition that, since $\theta_N = 0$, $\phi_N = 0$, which allows us to rearrange the previous equation to get
\begin{equation}
\phi_1 = \frac{\sum_{j=1}^{N-1}\sum_{i=1}^{j}q_iE_i}{1+\sum_{j=1}^{N-1}S_j}. 
\end{equation}
Here $\phi_i \equiv E_i \theta_i$ (not a dot product, just multiplication of elements), where $\theta_i$ is the conditional extinction time. 
These previous two equation allow us to solve for $\phi$, and therefore $\theta$. 
After all this, one arrives at the graph in figure \ref{condextntimefig}. 
The conditional times mostly follow the unconditioned time, except near the rare events that do not much contribute to the average. 
\begin{figure}[ht]
	\centering
	\includegraphics[scale=1]{Moran-withimmigration-condtimesmall}
	\caption{Mean time to fixation or extinction, conditioned on that event happening, given starting population/fraction. $g=0.7$, $N=100$, $\nu$ varies from 0.3 (highest) to 0.0001 (lowest). Grey is regular Moran results without immigration. } \label{condextntimefig}
\end{figure}

\section{Some Results}
With all that we've discovered, we can say something about the switching behaviour of this Moran population with immigrants. 
Likely, there are some limiting forms of the analytic expressions that will offer more insight - these are currently being investigated. 
Let's say the population starts in state $n=0$.  
Then at a rate $\nu g$ there will be an attempted invasion.  
The invasion will be successful only every $1/E_1$ attempts.  
Thus a successful invasion occurs every $1/\nu g E_1$ time units.  
%Of course, all this assumes that after the first invader is added, no others arrive until the first one succeeds or fails.  
We can compare the time between successful invasions, and the time between attempted invasions, with the time each attempt takes (successful or not). 
COMPARE SOME ACTUAL NUMBERS
ALSO REFER BACK TO THE GRAPHS
%For $g=0.1$, $N=50$, $\nu=0.01$ this gives an attempt (invasion or suppression) time of $\tau[1] = 243.138$, a time between attempts of $1/\nu(1-g) = 111.111$, and a time between successful attempts of $1/\nu(1-g)(1-E_1) = 7919.01$. 


